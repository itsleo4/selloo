<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Selloo - Store</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        :root {
            --color-neon-green: #39FF14;
            --color-neon-pink: #FF1493;
            --color-dark-bg: #0F0F0F;
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-[--color-dark-bg] text-gray-100 min-h-screen">

    <!-- Header for the public store -->
    <header class="sticky top-0 z-50 bg-[--color-dark-bg] bg-opacity-90 backdrop-filter backdrop-blur-lg shadow-xl py-4 border-b border-gray-800">
        <div class="container mx-auto flex justify-between items-center px-4 md:px-8">
            <a href="index.html" class="text-3xl font-extrabold text-white">Selloo</a>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 md:p-8">
        <h2 id="store-header" class="text-4xl font-extrabold text-white text-center md:text-left">
            <span class="text-[--color-neon-pink]">Loading...</span>
        </h2>

        <!-- Product List -->
        <div id="publicStoreProducts" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
            <!-- Product cards will be rendered here dynamically -->
        </div>

        <p id="emptyStoreMessage" class="hidden text-center text-gray-500 mt-8">This store has no products yet.</p>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyAoe8uFfecihMO_FbCNQ3zIKikfHcVZy8A",
              authDomain: "selloo-6eb2b.firebaseapp.com",
              projectId: "selloo-6eb2b",
              storageBucket: "selloo-6eb2b.firebasestorage.app",
              messagingSenderId: "825664800500",
              appId: "1:825664800500:web:38001172e411163d3440a1",
              measurementId: "G-Y26MH0D6HD"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // DOM Elements
            const pageTitle = document.getElementById('pageTitle');
            const storeHeader = document.getElementById('store-header');
            const publicStoreProducts = document.getElementById('publicStoreProducts');
            const emptyStoreMessage = document.getElementById('emptyStoreMessage');

            // Function to get query parameter from URL
            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }

            // Function to render the products
            function renderProducts(products) {
                publicStoreProducts.innerHTML = ''; // Clear existing products
                if (products.length === 0) {
                    emptyStoreMessage.classList.remove('hidden');
                } else {
                    emptyStoreMessage.classList.add('hidden');
                    products.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'bg-gray-800 rounded-xl p-4 shadow-xl border border-gray-700 relative group overflow-hidden';
                        
                        let cardContent = `
                            <img src="${product.imageUrl}" alt="${product.name}" class="rounded-lg w-full h-48 object-cover mb-4 border-2 border-gray-600" onerror="this.src='https://placehold.co/400x300/1F2937/D1D5DB?text=No+Image';">
                            <h3 class="text-xl font-bold text-white mb-2">${product.name}</h3>
                            <p class="text-[--color-neon-green] text-lg font-semibold mb-2">$${product.price}</p>
                            <p class="text-sm text-gray-400 mb-4">${product.description || ''}</p>
                            <a href="${product.paymentLink}" target="_blank" class="w-full inline-block text-center bg-[--color-neon-pink] text-white py-2 rounded-lg text-sm font-medium hover:bg-opacity-80 transition duration-300 shadow-md">
                                Buy Now
                            </a>
                        `;

                        // Add the donate button if either UPI or PayPal is provided
                        if (product.donateUPI || product.donatePayPal) {
                            cardContent += `
                                <div class="mt-4">
                                    <button class="donate-btn w-full inline-block text-center bg-gray-700 text-gray-300 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition duration-300 shadow-md">
                                        <span class="text-red-500">❤️</span> Donate
                                    </button>
                                    <div class="donate-options hidden mt-2 text-center text-gray-300 bg-gray-700 rounded-lg p-2 space-y-2">
                                        ${product.donateUPI ? `<p class="text-xs"><strong>UPI:</strong> ${product.donateUPI}</p>` : ''}
                                        ${product.donatePayPal ? `<a href="${product.donatePayPal}" target="_blank" class="text-xs text-[--color-neon-green] hover:underline">Donate via PayPal</a>` : ''}
                                    </div>
                                </div>
                            `;
                        }
                        
                        productCard.innerHTML = cardContent;
                        publicStoreProducts.appendChild(productCard);
                    });
                    
                    // Attach event listeners to the new donate buttons
                    document.querySelectorAll('.donate-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const donateOptions = e.target.closest('div').querySelector('.donate-options');
                            if (donateOptions) {
                                donateOptions.classList.toggle('hidden');
                            }
                        });
                    });
                }
            }

            // Main function to fetch store data on page load
            function loadStore() {
                const storeOwnerUserId = getQueryParam('uid');

                if (!storeOwnerUserId) {
                    storeHeader.innerHTML = 'Store Not Found';
                    storeHeader.classList.add('text-center', 'text-red-500');
                    return;
                }

                storeHeader.innerHTML = `<span class="text-[--color-neon-pink]">${storeOwnerUserId}</span>'s Store`;
                pageTitle.textContent = `Selloo - ${storeOwnerUserId}'s Store`;

                const productsRef = db.collection('users').doc(storeOwnerUserId).collection('products').orderBy('createdAt', 'desc');
                productsRef.onSnapshot(snapshot => {
                    const products = [];
                    snapshot.forEach(doc => {
                        // Include the document ID in the product data
                        products.push({ id: doc.id, ...doc.data() });
                    });
                    renderProducts(products);
                }, error => {
                    console.error("Error fetching products:", error);
                    storeHeader.innerHTML = `<span class="text-red-500">Error Loading Store</span>`;
                    emptyStoreMessage.textContent = "Failed to load products. Please try again later.";
                    emptyStoreMessage.classList.remove('hidden');
                });
            }

            loadStore();
        });
    </script>
</body>
</html>
